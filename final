import cv2
import numpy as np
import matplotlib.pyplot as plt

img_height = 150
img_wight = 120
img_len = img_wight * img_height
img_list = []
imgAverage = []

train_image = 300
def processing_img(path):
    imgColor = cv2.imread(path,cv2.IMREAD_COLOR)
    gray = cv2.cvtColor(imgColor,cv2.COLOR_BGR2GRAY)
    #cv2.imshow("image - " + str(i),gray)
    Finaly_gray = cv2.resize(gray,(img_wight,img_height))
    return np.array(Finaly_gray).flatten()

def show_img(inputing,imgname):
    img = np.reshape(inputing,(img_height,img_wight))
    img = img.astype('uint8')
    cv2.imshow(imgname,img)

def get_top_eigenpairs(matrix, k):
    eigenvalues, eigenvectors = np.linalg.eig(matrix)
    sorted_indices = np.argsort(eigenvalues)[::-1]
    sorted_eigenvalues = eigenvalues[sorted_indices]
    sorted_eigenvectors = eigenvectors[:, sorted_indices]

    top_eigenvalues = sorted_eigenvalues[:k]
    top_eigenvectors = sorted_eigenvectors[:, :k]

    return top_eigenvalues, top_eigenvectors
for i in range(0,train_image):
    path ="face_img/train/train{0:03d}.jpg".format(i)
    vector = processing_img(path)
    img_list.append(vector)

img_list = np.array(img_list)
img_list = img_list.astype('float32')

for i in range(0,img_len):
    sum = 0.0
    for j in range(0,train_image):
        sum += img_list[j][i]
    imgAverage.append(sum / train_image )

m = [] # 원본 - 평균 영상
mt = []
#show_img(imgAverage,"a")
covariance = [] # 공분산행렬

for i in range(0,train_image):
    m.append( [] )
    for j in range(0,img_len):
        m[i].append( img_list[i][j] - imgAverage[j] )

#for i in range(0,train_image):
    #show_img(m[i],"{0:03d}".format(i))
mt = np.array(m).T
m = np.array(m)

covariance.append(m.dot(mt))                  # 300 by 300
covariance = np.array(covariance)


covariance = np.reshape(covariance,(300,300))
#print(covariance.shape)

eigenvalues, eigenvectors = np.linalg.eig(covariance) # 고윳값 고유벡터 구하는 함수

#plt.plot(eigenvalues) #고윳값의 그래프를 보여줌
#plt.show()



sort_eigenvalues = []
len = len(eigenvalues)


v = 3 # 고유벡터 3개 사용

#print(eigenvectors.shape)

top_eigenvalues, top_eigenvectors = get_top_eigenpairs(covariance, v)
V = []
V = np.array(top_eigenvectors).T

x_hat = []

for i in range(0,img_len):
    x_hat.append(V[i]*m[i])

print(x_hat.shape)

#for i in range(0,len(eigenvalues)):
    #print("고윳값 {}: {}".format(i+1, eigenvalues[i]))
    #print("고유벡터 {}: {}".format(i+1, eigenvectors[:, i]))

num = int(input("테스트할 사진의 번호를 입력하시오: "))
test_path = "face_img/test/test{0:03d}.jpg".format(num)
test_img = processing_img(test_path)

print(test_img)
print(imgAverage)

testAverage = []
y_hat = []

for i in range(0, img_len):
    testAverage.append(test_img[i] - imgAverage[i])



for i in range(0, img_len):
    y_hat.append(V[i] * testAverage[i])


print(testAverage)

cv2.waitKey(0)
